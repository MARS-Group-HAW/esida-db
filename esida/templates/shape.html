{% extends 'base.html' %}

{% block title %}{{shape['name']}}{% endblock %}


{% block content %}
  <h1>{{ shape['name'] }}</h1>

  <div class="row">

    <div class="col col-md-6">


      <a href="{{ url_for('download_csv', shape_id=shape['id']) }}" download class="btn btn-primary">Parameters as CSV</a>

      <table class="table table-sm">
        <thead>
          <tr>
            <th>Information</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th>Region</th>
            <td>{{ shape.region_name }}</td>
          </tr>
          <tr>
            <th>District</th>
            <td>{{ shape.name }}</td>
          </tr>
          <tr>
            <th>Area</th>
            <td>{{ shape.human_readable_area() }} km<sup>2</sup></td>
          </tr>
        </tbody>
      </table>


    </div>

    <div class="col col-md-6">
      <div id="map" class="mb-3" style="width: 100%; height: 400px"></div>

      <div class="mb-3">
        <label for="copy-wkt" class="form-label">Copy <abbr title="Well-known text">WKT</abbr>:</label>
        <div class="input-group">
          <input type="text" id="copy-wkt" class="form-control" value="{{ shape.geom().wkt|safe }}">
          <!-- <button class="btn btn-outline-secondary" type="button" id="copy-button">Copy</button> -->
        </div>
      </div>

    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <h3>Data visualization</h3>
      <p>
        You can toggle the different parameters on the left pane to show them inside the line-chart.
      </p>
    </div>

    <div class="col-3">

      {% for p in data.columns[2:] %}
        <button type="button" data-bs-toggle="button" class="btn btn-sm btn-outline-secondary js-highchart-add-series mb-1" data-id="{{ p }}">{{ p }}</button>

      {% endfor %}

    </div>
    <div class="col-9">
      <div id="chart"></div>
    </div>

  </div>

{% endblock %}

{% block footer %}
<script>

var data = {{ data.to_json(orient="columns")|safe }}

var chart = Highcharts.chart('chart', {
  chart: {
    type: 'spline'
  },

  title: {
    text: 'Parameter values for {{ shape['name'] }}'
  },
  yAxis: {
    title: {
      text: 'Value of parameter'
    }
  },
  xAxis: {
    type: 'datetime',
    title: {
      text: 'Date'
    }
  },

  plotOptions: {
    series: {
      marker: {
        enabled: true
      }
    }
  },

  legend: {
    layout: 'vertical',
    align: 'right',
    verticalAlign: 'middle'
  },

  responsive: {
    rules: [{
        condition: {
            maxWidth: 500
        },
        chartOptions: {
            legend: {
                layout: 'horizontal',
                align: 'center',
                verticalAlign: 'bottom'
            }
        }
    }]
  }
});

$('.js-highchart-add-series').on('click', function() {
  var id = $(this).data('id');
  var becameActive = $(this).hasClass('active');

  if (becameActive) {
    var values = [];
    for(var k in data[id]) {
      values.push([Date.UTC(data['year'][k]), data[id][k]]);
    }

    chart.addSeries({
      id: id,
      name: id,
      data: values
    });
  } else {
    series = chart.get(id);
    if (series) {
      series.remove();
    }
  }
});
</script>

<script>
  var osmUrl    = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
  var osmAttrib = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
  var osm       = L.tileLayer(osmUrl, {maxZoom: 18, attribution: osmAttrib});

  var map_position = {lat: -6, lng: 35, zoom: 10};

  var map = L.map('map', {
    preferCanvas: true
  }).setView([map_position.lat, map_position.lng], map_position.zoom).addLayer(osm);

  shapes=[]
  var s = L.geoJSON({{ shape.geojson()|safe }} );
  shapes.push(s);
  var group_districts = L.featureGroup(shapes).addTo(map);
  map.fitBounds(group_districts.getBounds());

  var layerControl = L.control.layers().addTo(map);
  layerControl.addBaseLayer(osm, 'OSM');
  layerControl.addOverlay(group_districts, 'Districts');
  </script>
{% endblock %}
